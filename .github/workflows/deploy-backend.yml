name: Deploy Backend (Blue/Green)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Puxa o código do repositório
      - uses: actions/checkout@v4

      # 2. Deploy direto na VPS via SSH
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: deploy
          key: ${{ secrets.VPS_KEY }}
          port: 22
          script: |
            set -e

            APP_DIR=/var/www/albums-manager-api
            cd $APP_DIR

            echo "Atualizando arquivos do projeto"
            git pull origin main

            # Tag da imagem
            export TAG=${{ github.sha }}

            # Detecta qual container está rodando
            BLUE_RUNNING=$(docker ps --filter "name=api-blue" --filter "status=running" -q)
            GREEN_RUNNING=$(docker ps --filter "name=api-green" --filter "status=running" -q)

            if [ -n "$BLUE_RUNNING" ]; then
              NEW_COLOR="green"
              OLD_COLOR="blue"
              HEALTH_PORT=3334
            else
              NEW_COLOR="blue"
              OLD_COLOR="green"
              HEALTH_PORT=3333
            fi

            echo "Deploying $NEW_COLOR, mantendo $OLD_COLOR rodando até o healthcheck passar"

            # Build da nova imagem
            docker build -t albums-api:$TAG .

            # Sobe o novo container
            docker compose up -d api-$NEW_COLOR

            # Espera a API ficar pronta com retry de até 60 segundos
            MAX_RETRIES=12
            COUNT=0
            until curl -f http://localhost:$HEALTH_PORT/health; do
              COUNT=$((COUNT+1))
              if [ $COUNT -ge $MAX_RETRIES ]; then
                echo "Healthcheck falhou após esperar"
                docker compose stop api-$NEW_COLOR || true
                docker compose rm -f api-$NEW_COLOR || true
                exit 1
              fi
              echo "Aguardando API ficar pronta... ($COUNT/$MAX_RETRIES)"
              sleep 5
            done

            echo "Healthcheck passou! Trocando tráfego..."

            # Atualiza Nginx usando link simbólico (garante que não haja duplicatas)
            echo "Apontando Nginx para $NEW_COLOR..."
            sudo ln -sf /etc/nginx/templates/api-$NEW_COLOR.conf /etc/nginx/conf.d/api.conf

            # Verifica se a sintaxe está ok antes de dar reload
            sudo nginx -t && sudo nginx -s reload

            echo "Tráfego redirecionado com sucesso para $NEW_COLOR!"

            # Para o container antigo (apenas se ele estiver rodando)
            if [ -n "$OLD_COLOR" ]; then
                echo "Limpando versão antiga ($OLD_COLOR)..."
                docker compose stop api-$OLD_COLOR || true
                docker compose rm -f api-$OLD_COLOR || true
            fi
